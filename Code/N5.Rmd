---
title: "C1"
author: "MartinezLeines"
date: "2025-04-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r package, message=FALSE, warning=FALSE}
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(zoo)
library(kableExtra)
library(readxl)
library(writexl)
library(dplyr)
```

## Including Plots

You can also embed plots, for example:

```{r}
base_dir <- "D:/Geani/Box/Home Folder gnl13/Private/1 Academics/3 Time series/LeinesMartinez_ENV797_TSA_FinalProject" # Update this
data_dir <- file.path(base_dir, "Data")
output_dir <- file.path(base_dir, "Output")

file1 <- "oil_production_EC_2007_2024.xlsx"
file2 <- "oil_price_2007-2024.xlsx"
file3 <- "annual_oil_production_1972-2023.xlsx"
file4 <- "oil_data_2007_2024.xlsx"

file_path1 <- file.path(data_dir, file1)
file_path2 <- file.path(data_dir, file2)
file_path3 <- file.path(data_dir, file3)
file_path4 <- file.path(data_dir, file4)

oil_production <- read_excel(file_path1)
oil_prices <- read_excel(file_path2)
annual_oil_production <- read_excel(file_path3)
oil_data <- read_excel(file_path4)
```
```{r}
#I forced to 0 all the NA in our processed data
oil_data1<-oil_data |>
  mutate(date=as.Date(date))|>
  replace_na(list(barrels_b043 = 0, b043_share = 0))
```

```{r}
#Trim the table to include only columns you need
noil <- ncol(oil_data1)-2
nobs <- nrow(oil_data1) 
```


```{r}
p1 <-ggplot(oil_data1, aes(x = date, y = barrels_total)) +
  geom_line(color = "blue") +
  labs(title = "Monthly Oil Production in Ecuador", x = "Date", y = "Oil production") +
  theme_classic()

print(p1)

p2 <-ggplot(oil_data1, aes(x = date, y = wti_oil_price)) +
  geom_line(color = "darkgreen") +
  labs(title = "Monthly WTI Prices", x = "Date", y = "WTI Price")+
  theme_classic()

print(p2)

p3<- ggplot(oil_data1, aes(x = date, y = barrels_b043)) +
  geom_line(color = "red") +
  labs(title = "Monthly Block 43 ITT Production", x = "Date", y = "Block 43 ITT Production") +
  theme_classic()

print(p3)



```



```{r message=FALSE, warning=FALSE}
#I corrected the columns
ts_oil_total <- ts(oil_data1[,2],
                           start=c(2007,1),
                           frequency=12) 

ts_oil_b043 <- ts(oil_data1[,3],
                           start=c(2007,1),
                           frequency=12) 

ts_oil_price <- ts(oil_data1[,6],
                           start=c(2007,1),
                           frequency=12) 

```


```{r}
p4 <- autoplot(ts_oil_total)
print(p4)

p5 <- autoplot(ts_oil_b043)
print(p5)

p6 <- autoplot(ts_oil_price)
print(p6)
```

```{r}
# ACF and PACF for Production
Acf(ts_oil_total, lag.max = 40, main = "ACF of Production")
Pacf(ts_oil_total, lag.max = 40, main = "PACF of Production")
```



```{r}
# Decompose the Production series (additive decomposition)
decomp_prod <- decompose(ts_oil_total, type = "additive")
plot(decomp_prod)

# Remove the seasonal component
deseasonal_prod <- seasadj(decomp_prod)

# Compare the original and deseasonalized series
autoplot(ts_oil_total, series = "Original") +
  autolayer(deseasonal_prod, series = "Deseasonalized") +
  labs(title = "Production: Original vs. Deseasonalized")
```



```{r}
# Perform ADF test on the deseasonalized Production series
adf_result <- adf.test(deseasonal_prod, alternative = "stationary")
print(adf_result)
```
```{r}
# Difference the deseasonalized series
diff_prod <- diff(deseasonal_prod, differences = 1)

# Plot the differenced series
autoplot(diff_prod, main = "Differenced Deseasonalized Production") +
  labs(x = "Time", y = "Differenced Production")
```
```{r}
# Check stationarity again
adf_result_diff <- adf.test(diff_prod, alternative = "stationary")
print(adf_result_diff)
```
```{r}
# ACF and PACF for the differenced series
Acf(diff_prod, lag.max = 40, main = "ACF of Differenced Series")
Pacf(diff_prod, lag.max = 40, main = "PACF of Differenced Series")
```

> Analysis ACF: The spike at lag 1 appears somewhat negative (below the lower blue line), suggesting some immediate negative correlation with the first lag. That sometimes indicates an MA(1) effect or a negative AR(1) coefficient.

>Analysis PACF: There’s a notable negative spike at lag 1, and possibly some mild spikes around lag 3 or 4.

```{r}
# to the deseasonalized Production series
model_auto <- auto.arima(deseasonal_prod)
summary(model_auto)
```
```{r}
checkresiduals(model_auto)
```
> Analysis: the residuals mostly fluctuate around zero. It has outliers due to COVID and other event around 2022.It could be good to add them as dummies.

>Analysis ACF:  ACF looks mostly within the bounds, indicating little to no autocorrelation in the residuals. That’s a sign your ARIMA(0,1,2) model is adequately capturing time‐dependent structure. There are 3 main spikes at specific lags. 

>Analysis Residual histogram: The histogram looks centered near zero even when there are some outliers.

> Analysis test: p‐value (< 0.05) in the Ljung‐Box test indicates that there is still significant autocorrelation in residuals. The ARIMA(0,1,2) model hasn’t fully captured the time‐dependent structure of the data.

```{r}
Acf(residuals(model_auto))
Pacf(residuals(model_auto))

```
```{r}
model_sarima <- auto.arima(
  ts_oil_total,
  seasonal = TRUE
)

summary(model_sarima)
```

```{r}
checkresiduals(model_sarima)
```
> Analysis test: p‐value > 0.05, it suggests no significant autocorrelation is left. The  SARIMA(2,1,1)(0,0,1)[12] model has captured the time‐dependent structure of the data.


```{r}
Acf(residuals(model_sarima))
Pacf(residuals(model_sarima))
```
```{r}
# For example, create a matrix of external regressors from your oil_data
# Make sure the regressor vectors are of the same length as your Production series
xreg_all <- cbind(WTI = oil_data1$wti_oil_price, Block43 = oil_data1$barrels_b043)
```

```{r}
# Fit the SARIMAX model using auto.arima with xreg
model_sarimax <- auto.arima(deseasonal_prod, xreg = xreg_all, seasonal = TRUE)
summary(model_sarimax)


```

```{r}
# Check residuals for the SARIMAX model
checkresiduals(model_sarimax)

```
> Analysis: p‐value = 0.1569 (> 0.05) suggests no significant autocorrelation remains in the residuals.



